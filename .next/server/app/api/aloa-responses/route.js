"use strict";(()=>{var e={};e.id=4833,e.ids=[4833],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},68621:e=>{e.exports=require("punycode")},76162:e=>{e.exports=require("stream")},17360:e=>{e.exports=require("url")},71568:e=>{e.exports=require("zlib")},90309:(e,r,s)=>{s.r(r),s.d(r,{originalPathname:()=>c,patchFetch:()=>g,requestAsyncStorage:()=>f,routeModule:()=>p,serverHooks:()=>_,staticGenerationAsyncStorage:()=>m});var t={};s.r(t),s.d(t,{GET:()=>l,POST:()=>u});var o=s(49303),a=s(88716),n=s(60670),i=s(87070),d=s(76995);async function l(e){try{let{searchParams:r}=new URL(e.url),s=r.get("formId")||r.get("form_id"),t=r.get("userId")||r.get("user_id");if(!s)return i.NextResponse.json({error:"Form ID is required"},{status:400});if(!/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(s))return i.NextResponse.json({error:"Invalid form ID format"},{status:400});let o=d.O.from("aloa_form_responses").select(`
        *,
        aloa_form_response_answers (
          id,
          field_name,
          field_value
        )
      `).eq("aloa_form_id",s);t&&(o=o.eq("user_id",t));let{data:a,error:n}=await o.order("submitted_at",{ascending:!1});if(n)throw n;let l=a.map(e=>{let r={};return e.aloa_form_response_answers?.forEach(e=>{if(e.field_name)try{let s=JSON.parse(e.field_value);r[e.field_name]=s}catch{r[e.field_name]=e.field_value}}),{id:e.id,submittedAt:e.submitted_at,response_data:r,data:r}});return i.NextResponse.json({responses:l})}catch(e){return console.error("Error fetching aloa responses:",e),i.NextResponse.json({error:"Failed to fetch responses"},{status:500})}}async function u(e){try{let r;let s=await e.json();if(!s.formId)return i.NextResponse.json({error:"Form ID is required"},{status:400});if(!/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(s.formId))return i.NextResponse.json({error:"Invalid form ID format"},{status:400});let t=e.headers.get("X-CSRF-Token"),o=e.cookies.get("csrf-token")?.value;if(!t||!o||t!==o)return i.NextResponse.json({error:"Invalid CSRF token"},{status:403});let a=s.userId||s.user_id||null,n=!1;if(a){let{data:t}=await d.O.from("aloa_form_responses").select("id").eq("aloa_form_id",s.formId).eq("user_id",a).single();if(t){n=!0;let{data:o,error:a}=await d.O.from("aloa_form_responses").update({responses:s.data||{},submitted_at:new Date().toISOString(),ip_address:e.headers.get("x-forwarded-for")||e.headers.get("x-real-ip"),user_agent:e.headers.get("user-agent")}).eq("id",t.id).select().single();if(a)throw console.error("Error updating response:",a),a;r=o,await d.O.from("aloa_form_response_answers").delete().eq("response_id",r.id)}}if(!r){let{data:t,error:o}=await d.O.from("aloa_form_responses").insert([{aloa_form_id:s.formId,aloa_project_id:s.projectId||null,user_id:a,responses:s.data||{},submitted_at:new Date().toISOString(),ip_address:e.headers.get("x-forwarded-for")||e.headers.get("x-real-ip"),user_agent:e.headers.get("user-agent")}]).select().single();if(o)throw console.error("Error creating response:",o),o;r=t}let l=[];if(Object.entries(s.data||{}).forEach(([e,s])=>{null!=s&&""!==s&&l.push({response_id:r.id,field_name:e,field_value:"object"==typeof s?JSON.stringify(s):String(s)})}),l.length>0){let{error:e}=await d.O.from("aloa_form_response_answers").insert(l);if(e)throw console.error("Error storing answers:",e),e}if(!n){let{error:e}=await d.O.from("aloa_forms").update({submission_count:d.O.raw("submission_count + 1"),updated_at:new Date().toISOString()}).eq("id",s.formId);e&&console.error("Error updating submission count:",e)}return i.NextResponse.json({success:!0,message:"Form response submitted successfully",responseId:r.id})}catch(e){return console.error("Error submitting aloa response:",e),i.NextResponse.json({error:"Failed to submit response"},{status:500})}}let p=new o.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/aloa-responses/route",pathname:"/api/aloa-responses",filename:"route",bundlePath:"app/api/aloa-responses/route"},resolvedPagePath:"/Users/rosspalmer/Ross GitHub Projects/aloa-web-design-project-manager/app/api/aloa-responses/route.js",nextConfigOutput:"",userland:t}),{requestAsyncStorage:f,staticGenerationAsyncStorage:m,serverHooks:_}=p,c="/api/aloa-responses/route";function g(){return(0,n.patchFetch)({serverHooks:_,staticGenerationAsyncStorage:m})}},76995:(e,r,s)=>{s.d(r,{O:()=>n});var t=s(69498);let o="https://eycgzjqwowrdmjlzqqyg.supabase.co",a="sb_publishable_eG0lH_ACpyOjqG44mN_5PA_1-oFLr5n",n=null;o&&a?n=(0,t.eI)(o,a):console.error("Warning: Supabase environment variables are missing")}};var r=require("../../../webpack-runtime.js");r.C(e);var s=e=>r(r.s=e),t=r.X(0,[9276,5972,9498],()=>s(90309));module.exports=t})();