"use strict";(()=>{var e={};e.id=9456,e.ids=[9456],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},68621:e=>{e.exports=require("punycode")},76162:e=>{e.exports=require("stream")},17360:e=>{e.exports=require("url")},71568:e=>{e.exports=require("zlib")},30172:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>q,patchFetch:()=>v,requestAsyncStorage:()=>m,routeModule:()=>_,serverHooks:()=>g,staticGenerationAsyncStorage:()=>f});var o={};r.r(o),r.d(o,{DELETE:()=>j,GET:()=>c,PATCH:()=>d,POST:()=>p,PUT:()=>u});var s=r(49303),a=r(88716),i=r(60670),n=r(87070),l=r(76995);async function c(e,{params:t}){try{let{projectId:e}=t,{data:r,error:o}=await l.O.from("aloa_projectlets").select(`
        *,
        aloa_project_forms (
          id,
          title,
          description,
          form_type,
          is_active,
          responses_required,
          responses_received
        )
      `).eq("project_id",e).order("sequence_order",{ascending:!0});if(o)return console.error("Error fetching projectlets:",o),n.NextResponse.json({error:"Failed to fetch projectlets"},{status:500});let s=r.length,a=r.filter(e=>"completed"===e.status).length;return n.NextResponse.json({projectlets:r,stats:{total:s,completed:a,inProgress:r.filter(e=>"in_progress"===e.status).length,available:r.filter(e=>"available"===e.status).length,locked:r.filter(e=>"locked"===e.status).length,completionPercentage:s>0?Math.round(a/s*100):0}})}catch(e){return console.error("Error in projectlets route:",e),n.NextResponse.json({error:"Internal server error"},{status:500})}}async function p(e,{params:t}){try{let{projectId:r}=t,{name:o,description:s,type:a}=await e.json(),{data:i}=await l.O.from("aloa_projectlets").select("sequence_order").eq("project_id",r).order("sequence_order",{ascending:!1}).limit(1).single(),c=i?i.sequence_order+1:0,{data:p,error:d}=await l.O.from("aloa_projectlets").insert([{project_id:r,name:o||`New Projectlet ${c+1}`,description:s||"Click to edit description",type:a||"design",status:"available",sequence_order:c,metadata:{}}]).select().single();if(d)return console.error("Error creating projectlet:",d),n.NextResponse.json({error:"Failed to create projectlet"},{status:500});return await l.O.from("aloa_project_timeline").insert([{project_id:r,projectlet_id:p.id,event_type:"projectlet_created",description:`"${p.name}" added to project`,metadata:{}}]),n.NextResponse.json({success:!0,projectlet:p})}catch(e){return console.error("Error creating projectlet:",e),n.NextResponse.json({error:"Internal server error"},{status:500})}}async function d(e,{params:t}){try{let{projectId:r}=t,{projectletId:o,status:s,metadata:a}=await e.json(),{data:i,error:c}=await l.O.from("aloa_projectlets").update({status:s,...a&&{metadata:a},..."completed"===s&&{completion_date:new Date().toISOString()}}).eq("id",o).eq("project_id",r).select().single();if(c)return console.error("Error updating projectlet:",c),n.NextResponse.json({error:"Failed to update projectlet"},{status:500});if("completed"===s){let{data:e}=await l.O.from("aloa_projectlets").select().eq("project_id",r).eq("status","locked").gt("sequence_order",i.sequence_order).order("sequence_order",{ascending:!0}).limit(1).single();e&&e.unlock_condition?.type==="previous_complete"&&(await l.O.from("aloa_projectlets").update({status:"available"}).eq("id",e.id),await l.O.from("aloa_project_timeline").insert([{project_id:r,projectlet_id:e.id,event_type:"projectlet_unlocked",description:`"${e.name}" is now available`,metadata:{previous_projectlet:i.name}}])),await l.O.from("aloa_project_timeline").insert([{project_id:r,projectlet_id:o,event_type:"projectlet_completed",description:`"${i.name}" completed`,metadata:{completion_date:new Date().toISOString()}}])}return n.NextResponse.json({success:!0,projectlet:i})}catch(e){return console.error("Error updating projectlet:",e),n.NextResponse.json({error:"Internal server error"},{status:500})}}async function u(e,{params:t}){try{let{projectId:r}=t,{projectletId:o,name:s,description:a,type:i,formId:c,deadline:p,metadata:d}=await e.json(),u={};void 0!==s&&(u.name=s),void 0!==a&&(u.description=a),void 0!==i&&(u.type=i),void 0!==p&&(u.deadline=p),void 0!==d&&(u.metadata=d);let{data:j,error:_}=await l.O.from("aloa_projectlets").update(u).eq("id",o).eq("project_id",r).select().single();if(_)return console.error("Error updating projectlet details:",_),n.NextResponse.json({error:"Failed to update projectlet details"},{status:500});if(void 0!==c){if(c){let{data:e}=await l.O.from("aloa_project_forms").select("id").eq("projectlet_id",o).single();e?await l.O.from("aloa_project_forms").update({form_id:c}).eq("projectlet_id",o):await l.O.from("aloa_project_forms").insert([{project_id:r,projectlet_id:o,form_id:c,title:j.name+" Form",form_type:"projectlet",is_active:!0}]),await l.O.from("aloa_forms").update({aloa_project_id:r}).eq("id",c)}else await l.O.from("aloa_project_forms").delete().eq("projectlet_id",o)}let{data:m}=await l.O.from("aloa_projectlets").select(`
        *,
        aloa_project_forms (
          id,
          form_id,
          title,
          description,
          form_type,
          is_active,
          responses_required,
          responses_received
        )
      `).eq("id",o).single();return n.NextResponse.json({success:!0,projectlet:m})}catch(e){return console.error("Error updating projectlet details:",e),n.NextResponse.json({error:"Internal server error"},{status:500})}}async function j(e,{params:t}){try{let{searchParams:r}=new URL(e.url),o=r.get("projectletId");if(!o)return n.NextResponse.json({error:"Projectlet ID is required"},{status:400});let{error:s}=await l.O.from("aloa_projectlets").delete().eq("id",o).eq("project_id",t.projectId);if(s)return console.error("Error deleting projectlet:",s),n.NextResponse.json({error:"Failed to delete projectlet"},{status:500});return n.NextResponse.json({success:!0,message:"Projectlet deleted successfully"})}catch(e){return console.error("Error in DELETE projectlet:",e),n.NextResponse.json({error:"Internal server error"},{status:500})}}let _=new s.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/aloa-projects/[projectId]/projectlets/route",pathname:"/api/aloa-projects/[projectId]/projectlets",filename:"route",bundlePath:"app/api/aloa-projects/[projectId]/projectlets/route"},resolvedPagePath:"/Users/rosspalmer/Ross GitHub Projects/aloa-web-design-project-manager/app/api/aloa-projects/[projectId]/projectlets/route.js",nextConfigOutput:"",userland:o}),{requestAsyncStorage:m,staticGenerationAsyncStorage:f,serverHooks:g}=_,q="/api/aloa-projects/[projectId]/projectlets/route";function v(){return(0,i.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:f})}},76995:(e,t,r)=>{r.d(t,{O:()=>i});var o=r(69498);let s="https://eycgzjqwowrdmjlzqqyg.supabase.co",a="sb_publishable_eG0lH_ACpyOjqG44mN_5PA_1-oFLr5n",i=null;s&&a?i=(0,o.eI)(s,a):console.error("Warning: Supabase environment variables are missing")}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),o=t.X(0,[9276,5972,9498],()=>r(30172));module.exports=o})();