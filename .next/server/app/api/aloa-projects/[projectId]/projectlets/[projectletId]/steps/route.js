"use strict";(()=>{var e={};e.id=5864,e.ids=[5864],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},68621:e=>{e.exports=require("punycode")},76162:e=>{e.exports=require("stream")},17360:e=>{e.exports=require("url")},71568:e=>{e.exports=require("zlib")},19733:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>g,patchFetch:()=>f,requestAsyncStorage:()=>_,routeModule:()=>j,serverHooks:()=>m,staticGenerationAsyncStorage:()=>q});var s={};r.r(s),r.d(s,{DELETE:()=>u,GET:()=>i,PATCH:()=>d,POST:()=>c});var o=r(49303),a=r(88716),n=r(60670),p=r(87070),l=r(76995);async function i(e,{params:t}){try{let{projectId:e,projectletId:r}=t,{data:s,error:o}=await l.O.from("aloa_projectlet_steps").select("*").eq("projectlet_id",r).eq("project_id",e).order("sequence_order",{ascending:!0});if(o)return console.error("Error fetching steps:",o),p.NextResponse.json({error:"Failed to fetch steps"},{status:500});return p.NextResponse.json({steps:s||[],count:s?.length||0})}catch(e){return console.error("Error in steps route:",e),p.NextResponse.json({error:"Internal server error"},{status:500})}}async function c(e,{params:t}){try{let{projectId:r,projectletId:s}=t,o=await e.json(),{data:a}=await l.O.from("aloa_projectlet_steps").select("sequence_order").eq("projectlet_id",s).order("sequence_order",{ascending:!1}).limit(1).single(),n={projectlet_id:s,project_id:r,name:o.name,description:o.description,type:o.type,sequence_order:(a?.sequence_order||0)+1,is_required:!1!==o.is_required,form_id:o.form_id||null,link_url:o.link_url||null,metadata:o.metadata||{}},{data:i,error:c}=await l.O.from("aloa_projectlet_steps").insert([n]).select().single();if(c)return console.error("Error creating step:",c),p.NextResponse.json({error:"Failed to create step"},{status:500});return p.NextResponse.json({success:!0,step:i})}catch(e){return console.error("Error creating step:",e),p.NextResponse.json({error:"Internal server error"},{status:500})}}async function d(e,{params:t}){try{let{projectId:r,projectletId:s}=t,{stepId:o,...a}=await e.json();if(!o)return p.NextResponse.json({error:"Step ID required"},{status:400});"completed"===a.status&&(a.completed_at=new Date().toISOString());let{data:n,error:i}=await l.O.from("aloa_projectlet_steps").update(a).eq("id",o).eq("projectlet_id",s).eq("project_id",r).select().single();if(i)return console.error("Error updating step:",i),p.NextResponse.json({error:"Failed to update step"},{status:500});let{data:c}=await l.O.from("aloa_projectlet_steps").select("status, is_required").eq("projectlet_id",s),d=c?.filter(e=>e.is_required)||[],u=d.filter(e=>"completed"===e.status);if(d.length>0&&u.length===d.length){await l.O.from("aloa_projectlets").update({status:"completed",completion_date:new Date().toISOString()}).eq("id",s);let{data:e}=await l.O.from("aloa_projectlets").select("sequence_order").eq("id",s).single();if(e){let{data:t}=await l.O.from("aloa_projectlets").select("id").eq("project_id",r).eq("status","locked").gt("sequence_order",e.sequence_order).order("sequence_order",{ascending:!0}).limit(1).single();t&&await l.O.from("aloa_projectlets").update({status:"available"}).eq("id",t.id)}await l.O.from("aloa_project_timeline").insert([{project_id:r,projectlet_id:s,event_type:"projectlet_completed",description:"All required steps completed",metadata:{auto_completed:!0}}])}else"in_progress"===a.status&&d.length>0&&await l.O.from("aloa_projectlets").update({status:"in_progress"}).eq("id",s).eq("status","available");return p.NextResponse.json({success:!0,step:n})}catch(e){return console.error("Error updating step:",e),p.NextResponse.json({error:"Internal server error"},{status:500})}}async function u(e,{params:t}){try{let{projectId:r,projectletId:s}=t,{searchParams:o}=new URL(e.url),a=o.get("stepId");if(!a)return p.NextResponse.json({error:"Step ID required"},{status:400});let{error:n}=await l.O.from("aloa_projectlet_steps").delete().eq("id",a).eq("projectlet_id",s).eq("project_id",r);if(n)return console.error("Error deleting step:",n),p.NextResponse.json({error:"Failed to delete step"},{status:500});let{data:i}=await l.O.from("aloa_projectlet_steps").select("id").eq("projectlet_id",s).order("sequence_order",{ascending:!0});for(let e=0;e<i.length;e++)await l.O.from("aloa_projectlet_steps").update({sequence_order:e+1}).eq("id",i[e].id);return p.NextResponse.json({success:!0,message:"Step deleted successfully"})}catch(e){return console.error("Error deleting step:",e),p.NextResponse.json({error:"Internal server error"},{status:500})}}let j=new o.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/aloa-projects/[projectId]/projectlets/[projectletId]/steps/route",pathname:"/api/aloa-projects/[projectId]/projectlets/[projectletId]/steps",filename:"route",bundlePath:"app/api/aloa-projects/[projectId]/projectlets/[projectletId]/steps/route"},resolvedPagePath:"/Users/rosspalmer/Ross GitHub Projects/aloa-web-design-project-manager/app/api/aloa-projects/[projectId]/projectlets/[projectletId]/steps/route.js",nextConfigOutput:"",userland:s}),{requestAsyncStorage:_,staticGenerationAsyncStorage:q,serverHooks:m}=j,g="/api/aloa-projects/[projectId]/projectlets/[projectletId]/steps/route";function f(){return(0,n.patchFetch)({serverHooks:m,staticGenerationAsyncStorage:q})}},76995:(e,t,r)=>{r.d(t,{O:()=>n});var s=r(69498);let o="https://eycgzjqwowrdmjlzqqyg.supabase.co",a="sb_publishable_eG0lH_ACpyOjqG44mN_5PA_1-oFLr5n",n=null;o&&a?n=(0,s.eI)(o,a):console.error("Warning: Supabase environment variables are missing")}};var t=require("../../../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[9276,5972,9498],()=>r(19733));module.exports=s})();