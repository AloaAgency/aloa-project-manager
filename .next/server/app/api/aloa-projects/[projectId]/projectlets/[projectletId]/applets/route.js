"use strict";(()=>{var e={};e.id=3485,e.ids=[3485],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},68621:e=>{e.exports=require("punycode")},76162:e=>{e.exports=require("stream")},17360:e=>{e.exports=require("url")},71568:e=>{e.exports=require("zlib")},27013:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>f,patchFetch:()=>h,requestAsyncStorage:()=>g,routeModule:()=>j,serverHooks:()=>x,staticGenerationAsyncStorage:()=>m});var o={};r.r(o),r.d(o,{DELETE:()=>_,GET:()=>i,PATCH:()=>d,POST:()=>c,PUT:()=>u});var s=r(49303),a=r(88716),p=r(60670),n=r(87070),l=r(76995);async function i(e,{params:t}){try{let{projectletId:e}=t;console.log(`Fetching applets for projectlet: ${e}`);let{data:r,error:o}=await l.O.from("aloa_applets").select("*").eq("projectlet_id",e).order("order_index",{ascending:!0});if(o)return console.error("Error fetching applets:",o),n.NextResponse.json({error:"Failed to fetch applets"},{status:500});let s=await Promise.all(r.map(async e=>{let{data:t}=await l.O.from("aloa_applet_progress").select("user_id, status, completion_percentage, completed_at").eq("applet_id",e.id),r=t?.filter(e=>"completed"===e.status||"approved"===e.status)||[],o=t?.filter(e=>"in_progress"===e.status)||[];return{...e,user_progress_summary:{total_users:t?.length||0,completed_count:r.length,in_progress_count:o.length,completed_users:r,all_progress:t||[]}}}));return console.log(`Found ${s?.length||0} applets for projectlet ${e}`),n.NextResponse.json({applets:s||[]})}catch(e){return console.error("Error in applets route:",e),n.NextResponse.json({error:"Internal server error"},{status:500})}}async function c(e,{params:t}){try{let{projectletId:r}=t,o=await e.json(),{data:s}=await l.O.from("aloa_applets").select("order_index").eq("projectlet_id",r).order("order_index",{ascending:!1}).limit(1).single(),a=s?s.order_index+1:0,p={projectlet_id:r,name:o.name,description:o.description,type:o.type,order_index:a,config:o.config||{},form_id:o.form_id,requires_approval:o.requires_approval||!1,client_instructions:o.client_instructions,internal_notes:o.internal_notes,client_can_skip:o.client_can_skip||!1,library_applet_id:o.library_applet_id};console.log("Creating applet with data:",p);let{data:i,error:c}=await l.O.from("aloa_applets").insert([p]).select().single();if(c)return console.error("Error creating applet:",c),n.NextResponse.json({error:"Failed to create applet"},{status:500});return console.log("Successfully created applet:",i),n.NextResponse.json({applet:i})}catch(e){return console.error("Error in applet creation:",e),n.NextResponse.json({error:"Internal server error"},{status:500})}}async function u(e,{params:t}){try{let{appletId:t,...r}=await e.json();console.log("Updating applet:",t,"with data:",r);let{data:o,error:s}=await l.O.from("aloa_applets").update(r).eq("id",t).select().single();if(s)return console.error("Error updating applet:",s),n.NextResponse.json({error:"Failed to update applet"},{status:500});return console.log("Successfully updated applet:",o),n.NextResponse.json({applet:o})}catch(e){return console.error("Error in applet update:",e),n.NextResponse.json({error:"Internal server error"},{status:500})}}async function d(e,{params:t}){try{let{appletId:r,status:o,completion_percentage:s}=await e.json(),a={status:o};void 0!==s&&(a.completion_percentage=s),"active"===o||"in_progress"===o?a.started_at=new Date().toISOString():("completed"===o||"approved"===o)&&(a.completed_at=new Date().toISOString(),a.completion_percentage=100);let{data:p,error:i}=await l.O.from("aloa_applets").update(a).eq("id",r).select().single();if(i)return console.error("Error updating applet status:",i),n.NextResponse.json({error:"Failed to update applet status"},{status:500});return await l.O.from("aloa_applet_interactions").insert([{applet_id:r,project_id:t.projectId,interaction_type:"approved"===o?"approval":"submission",user_role:"admin",data:{status_change:o}}]),n.NextResponse.json({applet:p})}catch(e){return console.error("Error in applet status update:",e),n.NextResponse.json({error:"Internal server error"},{status:500})}}async function _(e,{params:t}){try{let{searchParams:t}=new URL(e.url),r=t.get("appletId");if(!r)return n.NextResponse.json({error:"Applet ID required"},{status:400});let{error:o}=await l.O.from("aloa_applets").delete().eq("id",r);if(o)return console.error("Error deleting applet:",o),n.NextResponse.json({error:"Failed to delete applet"},{status:500});return n.NextResponse.json({success:!0})}catch(e){return console.error("Error in applet deletion:",e),n.NextResponse.json({error:"Internal server error"},{status:500})}}let j=new s.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/aloa-projects/[projectId]/projectlets/[projectletId]/applets/route",pathname:"/api/aloa-projects/[projectId]/projectlets/[projectletId]/applets",filename:"route",bundlePath:"app/api/aloa-projects/[projectId]/projectlets/[projectletId]/applets/route"},resolvedPagePath:"/Users/rosspalmer/Ross GitHub Projects/aloa-web-design-project-manager/app/api/aloa-projects/[projectId]/projectlets/[projectletId]/applets/route.js",nextConfigOutput:"",userland:o}),{requestAsyncStorage:g,staticGenerationAsyncStorage:m,serverHooks:x}=j,f="/api/aloa-projects/[projectId]/projectlets/[projectletId]/applets/route";function h(){return(0,p.patchFetch)({serverHooks:x,staticGenerationAsyncStorage:m})}},76995:(e,t,r)=>{r.d(t,{O:()=>p});var o=r(69498);let s="https://eycgzjqwowrdmjlzqqyg.supabase.co",a="sb_publishable_eG0lH_ACpyOjqG44mN_5PA_1-oFLr5n",p=null;s&&a?p=(0,o.eI)(s,a):console.error("Warning: Supabase environment variables are missing")}};var t=require("../../../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),o=t.X(0,[9276,5972,9498],()=>r(27013));module.exports=o})();