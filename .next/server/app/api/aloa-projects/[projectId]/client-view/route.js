"use strict";(()=>{var e={};e.id=8115,e.ids=[8115],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},68621:e=>{e.exports=require("punycode")},76162:e=>{e.exports=require("stream")},17360:e=>{e.exports=require("url")},71568:e=>{e.exports=require("zlib")},9265:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>f,patchFetch:()=>g,requestAsyncStorage:()=>u,routeModule:()=>d,serverHooks:()=>m,staticGenerationAsyncStorage:()=>_});var o={};r.r(o),r.d(o,{GET:()=>n,POST:()=>c});var s=r(49303),a=r(88716),l=r(60670),p=r(87070),i=r(76995);async function n(e,{params:t}){try{let{projectId:r}=t,{searchParams:o}=new URL(e.url),s=o.get("userId")||"anonymous";console.log(`Fetching client view for project: ${r}, user: ${s}`);let{data:a,error:l}=await i.O.from("aloa_projects").select("*").eq("id",r).single();if(l)return console.error("Error fetching project:",l),p.NextResponse.json({error:"Project not found"},{status:404});let{data:n,error:c}=await i.O.from("aloa_projectlets").select(`
        *,
        applets:aloa_applets(
          *
        )
      `).eq("project_id",r).order("sequence_order",{ascending:!0});if(c)return console.error("Error fetching projectlets:",c),p.NextResponse.json({error:"Failed to fetch projectlets"},{status:500});let d=n?.map(e=>({...e,applets:e.applets?.sort((e,t)=>e.order_index-t.order_index)||[]}))||[],{data:u}=await i.O.from("aloa_applet_progress").select("*").eq("project_id",r).eq("user_id",s),_={};for(let e of(u?.forEach(e=>{_[e.applet_id]=e}),d))for(let t of e.applets){let e=_[t.id];if(e?(t.user_status=e.status,t.user_completion_percentage=e.completion_percentage,t.user_started_at=e.started_at,t.user_completed_at=e.completed_at,t.form_progress=e.form_progress):(t.user_status="not_started",t.user_completion_percentage=0),"form"===t.type&&t.form_id){let{data:e}=await i.O.from("aloa_forms").select(`
              id, 
              title, 
              description, 
              url_id,
              status,
              sections,
              aloa_form_fields (
                id,
                field_label,
                field_name,
                field_type,
                required,
                placeholder,
                options,
                validation,
                field_order,
                help_text,
                default_value
              )
            `).eq("id",t.form_id).single();e&&(e.aloa_form_fields&&e.aloa_form_fields.sort((e,t)=>(e.field_order||0)-(t.field_order||0)),t.form=e)}}console.log("All projectlets:",d.map(e=>({name:e.name,status:e.status,appletCount:e.applets.length,applets:e.applets.map(e=>({name:e.name,user_status:e.user_status,type:e.type}))})));let m=d.reduce((e,t)=>"locked"===t.status&&0===t.applets.length?e+1:e+t.applets.length,0),f=0;d.forEach(e=>{e.applets.forEach(e=>{"completed"===e.user_status||"approved"===e.user_status?(f++,console.log(`Counting as completed: ${e.name} (status: ${e.user_status})`)):console.log(`Not completed: ${e.name} (status: ${e.user_status})`)})});let g=f,j=m>0?Math.round(g/m*100):0;console.log(`Calculation Debug - Total Projectlets: ${d.length} (${d.filter(e=>"locked"===e.status).length} locked), Estimated Total Applets: ${m}, Completed: ${g}, Percentage: ${j}%`);let h=d.length,w=0;for(let e of d)e.applets.length>0&&e.applets.every(e=>"completed"===e.user_status||"approved"===e.user_status)&&w++;return console.log(`Client view data - Applets: ${g}/${m} (${j}%), Projectlets: ${w}/${h}`),p.NextResponse.json({project:a,projectlets:d,stats:{totalApplets:m,completedApplets:g,progressPercentage:j}})}catch(e){return console.error("Error in client-view route:",e),p.NextResponse.json({error:"Internal server error"},{status:500})}}async function c(e,{params:t}){try{let{projectId:r}=t,{appletId:o,status:s,interactionType:a,data:l,userId:n="anonymous"}=await e.json();console.log(`Client interaction - Project: ${r}, Applet: ${o}, User: ${n}, Type: ${a}, Status: ${s}`);let{data:c,error:d}=await i.O.rpc("update_applet_progress",{p_applet_id:o,p_user_id:n,p_project_id:r,p_status:s,p_completion_percentage:"completed"===s?100:null,p_form_progress:l?.form_progress||null});if(d)return console.error("Error updating user progress:",d),p.NextResponse.json({error:"Failed to update progress"},{status:500});if(console.log("User progress updated successfully:",c),"form_submit"===a&&"completed"===s){let{data:e}=await i.O.from("aloa_applets").select("type, form_id, status").eq("id",o).single();if(e?.type==="form"&&e?.form_id){let{data:t}=await i.O.from("aloa_forms").select("status").eq("id",e.form_id).single(),r=t?.status==="closed"?"completed":"in_progress",s={status:r,completion_percentage:"completed"===r?100:50,..."completed"===r&&{completed_at:new Date().toISOString()}},{error:a}=await i.O.from("aloa_applets").update(s).eq("id",o);a&&console.error("Error updating applet status:",a)}}else if("completed"===s&&"form_submit"!==a){let e={status:"completed",completion_percentage:100,completed_at:new Date().toISOString()},{error:t}=await i.O.from("aloa_applets").update(e).eq("id",o);t&&console.error("Error updating applet default status:",t)}let{error:u}=await i.O.from("aloa_applet_interactions").insert([{applet_id:o,project_id:r,interaction_type:a,user_role:"client",data:l||{}}]);if(u&&console.error("Error recording interaction:",u),"completed"===s){let{data:e}=await i.O.from("aloa_applets").select("projectlet_id").eq("id",o).single();if(e?.projectlet_id){let{data:t}=await i.O.from("aloa_applets").select("status").eq("projectlet_id",e.projectlet_id);t?.every(e=>"completed"===e.status||"approved"===e.status)&&(await i.O.from("aloa_projectlets").update({status:"completed"}).eq("id",e.projectlet_id),console.log(`Projectlet ${e.projectlet_id} marked as completed`))}}return p.NextResponse.json({success:!0,progress:c})}catch(e){return console.error("Error in client interaction:",e),p.NextResponse.json({error:"Internal server error"},{status:500})}}let d=new s.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/aloa-projects/[projectId]/client-view/route",pathname:"/api/aloa-projects/[projectId]/client-view",filename:"route",bundlePath:"app/api/aloa-projects/[projectId]/client-view/route"},resolvedPagePath:"/Users/rosspalmer/Ross GitHub Projects/aloa-web-design-project-manager/app/api/aloa-projects/[projectId]/client-view/route.js",nextConfigOutput:"",userland:o}),{requestAsyncStorage:u,staticGenerationAsyncStorage:_,serverHooks:m}=d,f="/api/aloa-projects/[projectId]/client-view/route";function g(){return(0,l.patchFetch)({serverHooks:m,staticGenerationAsyncStorage:_})}},76995:(e,t,r)=>{r.d(t,{O:()=>l});var o=r(69498);let s="https://eycgzjqwowrdmjlzqqyg.supabase.co",a="sb_publishable_eG0lH_ACpyOjqG44mN_5PA_1-oFLr5n",l=null;s&&a?l=(0,o.eI)(s,a):console.error("Warning: Supabase environment variables are missing")}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),o=t.X(0,[9276,5972,9498],()=>r(9265));module.exports=o})();