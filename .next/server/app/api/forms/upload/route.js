"use strict";(()=>{var e={};e.id=1477,e.ids=[1477],e.modules={98860:e=>{e.exports=require("jsdom")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},84770:e=>{e.exports=require("crypto")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},68621:e=>{e.exports=require("punycode")},76162:e=>{e.exports=require("stream")},17360:e=>{e.exports=require("url")},71568:e=>{e.exports=require("zlib")},66872:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>g,patchFetch:()=>x,requestAsyncStorage:()=>m,routeModule:()=>c,serverHooks:()=>h,staticGenerationAsyncStorage:()=>f});var i={};r.r(i),r.d(i,{POST:()=>d});var o=r(49303),n=r(88716),s=r(60670),a=r(87070),l=r(76995),u=r(40259),p=r(77537);async function d(e){try{let t=e.headers.get("X-CSRF-Token"),r=e.cookies.get("csrf-token")?.value;if("true"!==e.headers.get("X-AI-Generated")&&(!t||!r||t!==r))return a.NextResponse.json({error:"Invalid CSRF token"},{status:403});let i=await e.formData(),o=i.get("markdown"),n=i.get("projectId");if(!o)return a.NextResponse.json({error:"No file uploaded"},{status:400});try{(0,p.L$)(o,{maxSize:5242880,allowedTypes:["text/plain","text/markdown","text/x-markdown","application/x-markdown"],allowedExtensions:[".txt",".md",".markdown"]})}catch(e){return a.NextResponse.json({error:e.message},{status:400})}let s=await o.text();if(s.includes("<script")||s.includes("javascript:")||s.includes("onerror=")||s.includes("onclick="))return a.NextResponse.json({error:"File contains potentially malicious content"},{status:400});if(s.length>1e5)return a.NextResponse.json({error:"File content is too large"},{status:400});try{let e=function(e){if(!e||"string"!=typeof e)throw Error("Invalid input: markdown must be a non-empty string");let t=e.split("\n"),r={title:"",description:"",fields:[]},i=null,o=!1,n=null,s=0;for(;s<t.length;){let e=t[s].trim();if(e.startsWith("# ")){r.title=e.substring(2).trim(),o=!0,s++;continue}if(o&&""===e){o=!1,s++;continue}if(o&&!e.startsWith("## ")){r.description+=(r.description?" ":"")+e,s++;continue}if(e.startsWith("## Section:")){i&&(r.fields.push(i),i=null),n=e.substring(11).trim(),s++;continue}if(e.startsWith("- ")){i&&r.fields.push(i);let o=e.substring(2).trim().split("|").map(e=>e.trim());if(o.length>=3){let e=o[0],r=e.includes("*"),a=e.replace("*","").trim().toLowerCase(),l=o[1],u=o[2],p=o.length>=4?o[3]:void 0,d="multiline"===a?"textarea":a;if(i={label:u,name:l,type:d,required:r,placeholder:p,section:n||"General Information"},["select","radio","checkbox","multiselect"].includes(d)){i.options=[];let e=s+1;for(;e<t.length;){let r=t[e];if(r.startsWith("  - "))i.options.push(r.substring(4).trim()),e++;else if(""===r.trim())e++;else break}s=e-1}}s++;continue}let a=e.match(/^(.+?)\s*\((text|email|phone|number|textarea|select|radio|checkbox|date|rating|multiselect)(?:\s*:\s*(.+?))?\)(\s*\*)?$/i);if(a){i&&r.fields.push(i);let e=a[1].trim(),t=a[2].toLowerCase(),o=a[3],l=!!a[4];i={label:e,name:e.toLowerCase().replace(/[^a-z0-9]+/g,"_"),type:"multiline"===t?"textarea":t,required:l,section:n||"General Information"},o&&["select","radio","checkbox","multiselect"].includes(t)&&(i.options=o.split(",").map(e=>e.trim())),s++;continue}if(e.startsWith("## ")&&!e.startsWith("## Section:")){let o=e.substring(3).trim();if(o.includes("*")||s+1<t.length&&t[s+1].trim().startsWith("Type:")){i&&r.fields.push(i);let e=o.match(/^(.*?)\s*\*\s*$/),t=e?e[1].trim():o,s=!!e;i={label:t,name:t.toLowerCase().replace(/[^a-z0-9]+/g,"_"),required:s,type:"text",section:n||"General Information"}}else i&&(r.fields.push(i),i=null),n=o;s++;continue}if(i&&e.startsWith("Type: ")){let r=e.substring(6).trim().toLowerCase(),o="multiline"===r?"textarea":r;if(i.type=o,["select","radio","checkbox","multiselect"].includes(o)){i.options=[];let e=s+1;for(;e<t.length;){let r=t[e];if(r.startsWith("  - "))i.options.push(r.substring(4).trim()),e++;else if(""===r.trim())e++;else break}s=e-1}s++;continue}if(i&&e.startsWith("Placeholder: ")){i.placeholder=e.substring(13).trim(),s++;continue}if(i&&e.startsWith("Min: ")){i.validation||(i.validation={});let t=e.substring(5).trim();"number"===i.type?i.validation.min=parseInt(t):i.validation.minLength=parseInt(t),s++;continue}if(i&&e.startsWith("Max: ")){i.validation||(i.validation={});let t=e.substring(5).trim();"number"===i.type?i.validation.max=parseInt(t):i.validation.maxLength=parseInt(t),s++;continue}if(i&&e.startsWith("Pattern: ")){i.validation||(i.validation={}),i.validation.pattern=e.substring(9).trim(),s++;continue}s++}if(i&&r.fields.push(i),!r.title||0===r.fields.length)throw Error("Invalid form structure");return r}(s),t={title:(0,p.oO)(e.title).substring(0,200),description:(0,p.oO)(e.description||"").substring(0,1e3),url_id:(0,u.x0)(10),markdown_content:s,project_id:n||null},{data:r,error:i}=await l.O.from("aloa_forms").insert([t]).select().single();if(i)throw i;if(e.fields&&e.fields.length>0){let t=e.fields.map((e,t)=>{if(!["text","email","tel","url","number","date","textarea","select","radio","checkbox","multiselect","rating"].includes(e.type))throw Error(`Invalid field type: ${e.type}`);return{form_id:r.id,field_label:(0,p.oO)(e.label).substring(0,200),field_name:(0,p.oO)(e.name).replace(/[^a-zA-Z0-9_-]/g,"_").substring(0,100),field_type:e.type,required:!!e.required,placeholder:e.placeholder?(0,p.oO)(e.placeholder).substring(0,200):null,options:Array.isArray(e.options)?e.options.map(e=>(0,p.oO)(e).substring(0,100)):null,validation:{...e.validation,section:(0,p.oO)(e.section||"General Information").substring(0,100)},field_order:Math.min(Math.max(0,t),1e3)}}),{error:i}=await l.O.from("aloa_form_fields").insert(t);if(i)throw await l.O.from("aloa_forms").delete().eq("id",r.id),i}return a.NextResponse.json({_id:r.id,urlId:r.url_id,title:r.title})}catch(e){return console.error("Parsing error:",e),a.NextResponse.json({error:e.message||"Invalid markdown format"},{status:400})}}catch(e){return console.error("Error processing upload:",e),a.NextResponse.json({error:"Failed to process upload"},{status:500})}}let c=new o.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/forms/upload/route",pathname:"/api/forms/upload",filename:"route",bundlePath:"app/api/forms/upload/route"},resolvedPagePath:"/Users/rosspalmer/Ross GitHub Projects/aloa-web-design-project-manager/app/api/forms/upload/route.js",nextConfigOutput:"",userland:i}),{requestAsyncStorage:m,staticGenerationAsyncStorage:f,serverHooks:h}=c,g="/api/forms/upload/route";function x(){return(0,s.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:f})}},77537:(e,t,r)=>{r.d(t,{H3:()=>a,I8:()=>p,KP:()=>u,L$:()=>d,jW:()=>n,lz:()=>l,oO:()=>s});var i=r(96468),o=r.n(i);function n(e){return e?o().sanitize(e,{ALLOWED_TAGS:["b","i","em","strong","a","p","br"],ALLOWED_ATTR:["href"],ALLOW_DATA_ATTR:!1,ALLOW_UNKNOWN_PROTOCOLS:!1,SAFE_FOR_TEMPLATES:!0,WHOLE_DOCUMENT:!1,RETURN_DOM:!1,RETURN_DOM_FRAGMENT:!1,RETURN_TRUSTED_TYPE:!1,FORCE_BODY:!1,SANITIZE_DOM:!0,IN_PLACE:!1,USE_PROFILES:!1,ALLOW_ARIA_ATTR:!1,ALLOW_DATA_ATTR:!1,DISALLOWED_TAGS:["script","style","iframe","object","embed","link"]}):""}function s(e){return e?("string"!=typeof e&&(e=String(e)),e.replace(/<[^>]*>/g,"").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').replace(/&#x27;/g,"'").replace(/&amp;/g,"&").trim().replace(/javascript:/gi,"").replace(/on\w+\s*=/gi,"").replace(/<script[^>]*>.*?<\/script>/gi,"").replace(/eval\(/gi,"").replace(/expression\(/gi,"")):""}function a(e){if(!e||"string"!=typeof e)return"";let t=e.toLowerCase().trim();if(!/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/.test(t))throw Error("Invalid email format");if(t.includes("\n")||t.includes("\r")||t.includes("%0a")||t.includes("%0d"))throw Error("Invalid email format - possible injection attempt");return t}function l(e){if(!e||"string"!=typeof e)return"";try{let t=new URL(e);if(!["http:","https:","mailto:"].includes(t.protocol))throw Error("Invalid URL protocol");if(e.toLowerCase().includes("javascript:")||e.toLowerCase().includes("data:"))throw Error("Potentially malicious URL");return t.href}catch(e){throw Error("Invalid URL format")}}function u(e,t=null,r=null){let i=Number(e);if(isNaN(i))throw Error("Invalid number format");if(null!==t&&i<t)throw Error(`Number must be at least ${t}`);if(null!==r&&i>r)throw Error(`Number must be at most ${r}`);return i}function p(e,t=null){if(!Array.isArray(e))return[];let r=e.filter(e=>null!=e).map(e=>s(String(e)));return t&&Array.isArray(t)?r.filter(e=>t.includes(e)):r}function d(e,t={}){let{maxSize:r=10485760,allowedTypes:i=["text/plain","text/markdown","text/x-markdown","application/x-markdown"],allowedExtensions:o=[".txt",".md",".markdown"]}=t;if(!e)throw Error("No file provided");if(e.size>r)throw Error(`File size exceeds maximum allowed size of ${r/1024/1024}MB`);if(i.length>0&&!i.includes(e.type))throw Error("File type not allowed");let n=e.name||"";if(!o.some(e=>n.toLowerCase().endsWith(e)))throw Error("File extension not allowed");if(n.split(".").length>2){let e=n.split(".");if(["exe","js","php","asp","jsp"].includes(e[e.length-2].toLowerCase()))throw Error("Suspicious file name detected")}return!0}},76995:(e,t,r)=>{r.d(t,{O:()=>s});var i=r(69498);let o="https://eycgzjqwowrdmjlzqqyg.supabase.co",n="sb_publishable_eG0lH_ACpyOjqG44mN_5PA_1-oFLr5n",s=null;o&&n?s=(0,i.eI)(o,n):console.error("Warning: Supabase environment variables are missing")},40259:(e,t,r)=>{let i,o;r.d(t,{x0:()=>s});let n=require("node:crypto");function s(e=21){var t;t=e|=0,!i||i.length<t?(i=Buffer.allocUnsafe(128*t),n.webcrypto.getRandomValues(i),o=0):o+t>i.length&&(n.webcrypto.getRandomValues(i),o=0),o+=t;let r="";for(let t=o-e;t<o;t++)r+="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict"[63&i[t]];return r}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),i=t.X(0,[9276,5972,9498,6468],()=>r(66872));module.exports=i})();