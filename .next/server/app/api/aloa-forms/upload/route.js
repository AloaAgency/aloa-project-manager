"use strict";(()=>{var e={};e.id=628,e.ids=[628],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},68621:e=>{e.exports=require("punycode")},76162:e=>{e.exports=require("stream")},17360:e=>{e.exports=require("url")},71568:e=>{e.exports=require("zlib")},52537:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>g,patchFetch:()=>h,requestAsyncStorage:()=>c,routeModule:()=>u,serverHooks:()=>m,staticGenerationAsyncStorage:()=>f});var o={};r.r(o),r.d(o,{POST:()=>p});var s=r(49303),i=r(88716),l=r(60670),n=r(87070),a=r(76995),d=r(40259);async function p(e){try{let t=await e.formData(),r=t.get("markdown"),o=t.get("projectId");if(!r)return n.NextResponse.json({error:"No file provided"},{status:400});let s=await r.text();console.log("=== Received markdown ==="),console.log(s),console.log("========================"),s.split("\n").forEach((e,t)=>{if(e.trim().startsWith("- ")){console.log(`Line ${t}: "${e}"`);let r=e.trim().substring(2).split("|").map(e=>e.trim());console.log(`  Parts: [${r.map(e=>`"${e}"`).join(", ")}]`)}});let i=function(e){let t=e.split("\n"),r={title:"",description:"",fields:[]},o="General Information";for(let e=0;e<t.length;e++){let s=t[e].trim();if(s.startsWith("# ")){if(r.title=s.substring(2).trim(),e+1<t.length){let o=t[e+1].trim();o&&!o.startsWith("#")&&!o.startsWith("-")&&!o.startsWith("  -")&&(r.description=o,e++)}}else if(s.startsWith("> "))r.description=s.substring(2).trim();else if(s.startsWith("## "))o=s.startsWith("## Section: ")?s.substring(12).trim():s.substring(3).trim();else if(s.startsWith("- ")){let i=s.substring(2).split("|").map(e=>e.trim());if(!(i.length>=3))continue;{let s=i[0],l=i[1],n=i[2],a=i[3]||"",d=s.includes("*"),p={type:s.replace("*","").trim(),name:l,label:n,required:d,section:o,position:r.fields.length,placeholder:a,validation:{section:o}},u=[];for(let r=e+1;r<t.length;r++){let e=t[r].trim();if(e.startsWith("  - "))u.push(e.substring(4).trim());else if(e&&!e.startsWith("  "))break}u.length>0&&(p.options=u),r.fields.push(p)}}else if(s.length>0&&!s.startsWith("#")&&!s.startsWith("  -")){let e=s.match(/^(.+?)\s*\(([^)]+)\)\s*(\*)?$/);if(e){let[,t,s,i]=e,l=!!i,n=s,a=[];if(s.includes(":")){let[e,t]=s.split(":");n=e.trim(),a=t.split(",").map(e=>e.trim())}let d={type:n,name:t.trim().toLowerCase().replace(/[?!.]/g,"").replace(/\s+/g,"_").replace(/[^a-z0-9_]/g,""),label:t.trim(),required:l,section:o,position:r.fields.length,placeholder:"",validation:{section:o}};a.length>0&&(d.options=a),r.fields.push(d)}}}return r}(s);console.log("=== Parsed form ==="),console.log(JSON.stringify(i,null,2)),console.log("=================="),console.log("Field count:",i.fields.length),0===i.fields.length&&console.log("WARNING: No fields parsed from markdown!");let l=(0,d.x0)(10),{data:p,error:u}=await a.O.from("aloa_forms").insert([{title:i.title,description:i.description,url_id:l,aloa_project_id:o||null,sections:i.fields.reduce((e,t)=>(e.includes(t.section)||e.push(t.section),e),[]),settings:{requiresAuth:!1,multipleSubmissions:!1,showProgressBar:!0},status:"active",created_at:new Date().toISOString(),updated_at:new Date().toISOString()}]).select().single();if(u)return console.error("Error creating form:",u),n.NextResponse.json({error:"Failed to create form"},{status:500});if(i.fields.length>0){let e=i.fields.map(e=>({aloa_form_id:p.id,field_label:e.label,field_name:e.name,field_type:e.type,required:e.required,placeholder:e.placeholder,options:e.options,validation:e.validation,field_order:e.position}));console.log("=== Fields to insert ==="),console.log(JSON.stringify(e,null,2)),console.log("=======================");let{error:t}=await a.O.from("aloa_form_fields").insert(e);if(t)return console.error("Error creating fields:",t),console.error("Fields that failed:",JSON.stringify(e,null,2)),await a.O.from("aloa_forms").delete().eq("id",p.id),n.NextResponse.json({error:"Failed to create form fields"},{status:500});console.log(`Successfully created ${e.length} fields`)}else console.log("No fields to create - form will have no questions!");return n.NextResponse.json({id:p.id,urlId:p.url_id,title:p.title,description:p.description,sections:p.sections,fieldCount:i.fields.length})}catch(e){return console.error("Error processing form upload:",e),n.NextResponse.json({error:"Internal server error"},{status:500})}}let u=new s.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/aloa-forms/upload/route",pathname:"/api/aloa-forms/upload",filename:"route",bundlePath:"app/api/aloa-forms/upload/route"},resolvedPagePath:"/Users/rosspalmer/Ross GitHub Projects/aloa-web-design-project-manager/app/api/aloa-forms/upload/route.js",nextConfigOutput:"",userland:o}),{requestAsyncStorage:c,staticGenerationAsyncStorage:f,serverHooks:m}=u,g="/api/aloa-forms/upload/route";function h(){return(0,l.patchFetch)({serverHooks:m,staticGenerationAsyncStorage:f})}},76995:(e,t,r)=>{r.d(t,{O:()=>l});var o=r(69498);let s="https://eycgzjqwowrdmjlzqqyg.supabase.co",i="sb_publishable_eG0lH_ACpyOjqG44mN_5PA_1-oFLr5n",l=null;s&&i?l=(0,o.eI)(s,i):console.error("Warning: Supabase environment variables are missing")},40259:(e,t,r)=>{let o,s;r.d(t,{x0:()=>l});let i=require("node:crypto");function l(e=21){var t;t=e|=0,!o||o.length<t?(o=Buffer.allocUnsafe(128*t),i.webcrypto.getRandomValues(o),s=0):s+t>o.length&&(i.webcrypto.getRandomValues(o),s=0),s+=t;let r="";for(let t=s-e;t<s;t++)r+="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict"[63&o[t]];return r}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),o=t.X(0,[9276,5972,9498],()=>r(52537));module.exports=o})();